<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Id="*" Name="FAIL - First Atari Image Library $(var.VERSION)" Language="1033"
		Version="$(var.VERSION)" Manufacturer="Piotr Fusik and Adrian Matoga"
		UpgradeCode="19995735-0DC9-4C92-848E-AEFF0407139C">

		<Package Description="FAIL - First Atari Image Library"
			Manufacturer="Piotr Fusik and Adrian Matoga" InstallerVersion="200" Compressed="yes" />
		<Upgrade Id="19995735-0DC9-4C92-848E-AEFF0407139C">
			<UpgradeVersion Property="NEWERVERSIONDETECTED" Minimum="$(var.VERSION)" OnlyDetect="yes" />
			<UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.VERSION)" IncludeMaximum="no" MigrateFeatures="yes" />
		</Upgrade>
		<Condition Message="Newer version of FAIL is already installed!">NOT NEWERVERSIONDETECTED</Condition>
		<Media Id="1" Cabinet="fail.cab" EmbedCab="yes" CompressionLevel="high" />

		<?define FIRST_EXT=gr8?>
		<?define OTHER_EXTS=hip;mic;int;tip;inp;hr;gr9;pic;cpr;cin;cci;apc;plm;ap3;ilc;rip;fnt;sxs;mcp;ghg;hr2?>
		<?define DOUBLECLICK=Double-click Atari image file in Windows Explorer to display it in ?>

		<Icon Id="faileye.ico" SourceFile="faileye.ico" />
		<Property Id="ARPHELPLINK" Value="http://fail.sourceforge.net/" />
		<Property Id="ARPPRODUCTICON" Value="faileye.ico" />
		<WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
		<!--<WixVariable Id="WixUIDialogBmp" Value="fail-dialog.jpg" />
		<WixVariable Id="WixUIBannerBmp" Value="fail-banner.jpg" /> -->

		<UI Id="MyWixUI_FeatureTree">
			<!-- customized WixUI_FeatureTree from Wix 3.0 - my changes commented -->
			<TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
			<TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
			<TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

			<Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
			<Property Id="WixUI_Mode" Value="FeatureTree" />

			<DialogRef Id="ErrorDlg" />
			<DialogRef Id="FatalError" />
			<DialogRef Id="FilesInUse" />
			<DialogRef Id="MsiRMFilesInUse" />
			<DialogRef Id="PrepareDlg" />
			<DialogRef Id="ProgressDlg" />
			<DialogRef Id="ResumeDlg" />
			<DialogRef Id="UserExit" />

			<Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>

			<Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="MyLicenseAgreementDlg">1</Publish>

			<Publish Dialog="MyLicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
			<Publish Dialog="MyLicenseAgreementDlg" Control="Next" Event="NewDialog" Value="MyCustomizeDlg">1</Publish>

			<Publish Dialog="MyCustomizeDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="1">Installed</Publish>
			<Publish Dialog="MyCustomizeDlg" Control="Back" Event="NewDialog" Value="MyLicenseAgreementDlg" Order="2">NOT Installed</Publish>
			<Publish Dialog="MyCustomizeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

			<Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MyCustomizeDlg" Order="1">NOT Installed OR WixUI_InstallMode = "Change"</Publish>
			<Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">Installed</Publish>

			<Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

			<Publish Dialog="MaintenanceTypeDlg" Control="ChangeButton" Event="NewDialog" Value="MyCustomizeDlg">1</Publish>
			<Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
			<Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
			<Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

			<Dialog Id="MyLicenseAgreementDlg" Width="370" Height="270" Title="!(loc.LicenseAgreementDlg_Title)">
				<!-- removed checkbox and replaced Next button with I Accept -->
				<Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="I &amp;Accept">
					<Publish Event="SpawnWaitDialog" Value="WaitForCostingDlg">CostingComplete = 1</Publish>
				</Control>
				<Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
				<Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
					<Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
				</Control>
				<Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.LicenseAgreementDlgBannerBitmap)" />
				<!-- higher license box because of the removed checkbox -->
				<Control Id="LicenseText" Type="ScrollableText" X="20" Y="60" Width="330" Height="155" Sunken="yes" TabSkip="no">
					<Text SourceFile="!(wix.WixUILicenseRtf)" />
				</Control>
				<!-- removed Print button -->
				<Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
				<Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
				<Control Id="Description" Type="Text" X="25" Y="23" Width="340" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.LicenseAgreementDlgDescription)" />
				<Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.LicenseAgreementDlgTitle)" />
			</Dialog>

			<Dialog Id="MyCustomizeDlg" Width="370" Height="270" Title="!(loc.CustomizeDlg_Title)" TrackDiskSpace="yes">
				<!-- wider and higher selection tree so it doesn't need scrollbars -->
				<Control Id="Tree" Type="SelectionTree" X="10" Y="75" Width="190" Height="125" Property="_BrowseProperty" Sunken="yes" TabSkip="no" Text="!(loc.CustomizeDlgTree)" />
				<Control Id="Browse" Type="PushButton" X="294" Y="210" Width="66" Height="17" Text="!(loc.CustomizeDlgBrowse)">
					<Publish Event="SelectionBrowse" Value="BrowseDlg">1</Publish>
					<Condition Action="hide">Installed</Condition>
					<Condition Action="disable">Installed</Condition>
				</Control>
				<!-- removed Reset and Disk Cost buttons, moved Back and Next buttons to their position in other dialogs -->
				<Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
				<Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)">
					<Subscribe Event="SelectionNoItems" Attribute="Enabled" />
				</Control>
				<Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
					<Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
				</Control>
				<Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.CustomizeDlgBannerBitmap)" />
				<Control Id="Text" Type="Text" X="25" Y="55" Width="320" Height="20" Text="!(loc.CustomizeDlgText)" />
				<Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
				<Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
				<Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.CustomizeDlgDescription)" />
				<Control Id="Title" Type="Text" X="15" Y="6" Width="210" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.CustomizeDlgTitle)" />
				<Control Id="Box" Type="GroupBox" X="210" Y="71" Width="150" Height="128" />
				<Control Id="ItemDescription" Type="Text" X="215" Y="90" Width="131" Height="50" Text="!(loc.CustomizeDlgItemDescription)">
					<Subscribe Event="SelectionDescription" Attribute="Text" />
				</Control>
				<Control Id="ItemSize" Type="Text" X="215" Y="140" Width="131" Height="50" Text="!(loc.CustomizeDlgItemSize)">
					<Subscribe Event="SelectionSize" Attribute="Text" />
				</Control>
				<Control Id="Location" Type="Text" X="90" Y="210" Width="200" Height="20" Text="!(loc.CustomizeDlgLocation)">
					<Subscribe Event="SelectionPath" Attribute="Text" />
					<Subscribe Event="SelectionPathOn" Attribute="Visible" />
					<Condition Action="hide">Installed</Condition>
				</Control>
				<Control Id="LocationLabel" Type="Text" X="25" Y="210" Width="65" Height="10" Text="!(loc.CustomizeDlgLocationLabel)">
					<Subscribe Event="SelectionPathOn" Attribute="Visible" />
					<Condition Action="hide">Installed</Condition>
				</Control>
			</Dialog>
		</UI>
		<UIRef Id="WixUI_Common" />

		<Property Id="XNVIEW.DIR">
			<RegistrySearch Id="xnview.installdir" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\XnView_is1" Name="InstallLocation" Type="directory" />
		</Property>
		<Property Id="IMCODERS.DIR">
			<RegistrySearch Id="imcoders.dir" Root="HKLM" Key="SOFTWARE\ImageMagick\Current" Name="CoderModulesPath" Type="directory" />
		</Property>

		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="FAIL.DIR" Name="FAIL">
					<Component Id="failwin.exe" Guid="*">
						<File Id="failwin.exe" Name="failwin.exe" Source="failwin.exe" Checksum="yes" KeyPath="yes" />
					</Component>
					<Component Id="failwin.ext" Guid="*">
						<RegistryValue Root="HKCR" Key="fail.file" Name="failwin" Type="integer" Value="1" KeyPath="yes" />
						<ProgId Id="failwin.file">
							<Extension Id="$(var.FIRST_EXT)">
								<!-- Verb needs to be defined only once per ProgId -->
								<Verb Id="open" TargetFile="failwin.exe" Argument='"%1"' />
							</Extension>
							<?foreach EXT in $(var.OTHER_EXTS)?>
								<Extension Id="$(var.EXT)" />
							<?endforeach?>
						</ProgId>
					</Component>
					<Component Id="fail2png.exe" Guid="*">
						<File Id="fail2png.exe" Name="fail2png.exe" Source="fail2png.exe" Checksum="yes" KeyPath="yes" />
					</Component>
					<Component Id="path" Guid="496125A6-884C-4A43-B075-268A248EF3E5">
						<Environment Id="path" Action="set" Name="Path" Part="last" Permanent="no" System="yes" Value="[FAIL.DIR]" />
						<CreateFolder />
					</Component>
					<Component Id="README_WindowsSetup.html" Guid="*">
						<File Id="README_WindowsSetup.html" Name="README_WindowsSetup.html" Source="README_WindowsSetup.html" KeyPath="yes" />
					</Component>
				</Directory>
				<Directory Id="XNVIEW.DIR" Name="XnView">
					<Directory Id="XNVIEWPLUG.DIR" Name="Plugins">
						<Component Id="Xfail1.usr" Guid="*">
							<File Id="Xfail1.usr" Name="Xfail1.usr" Source="Xfail1.usr" Checksum="yes" KeyPath="yes" />
						</Component>
						<Component Id="Xfail2.usr" Guid="*">
							<File Id="Xfail2.usr" Name="Xfail2.usr" Source="Xfail2.usr" Checksum="yes" KeyPath="yes" />
						</Component>
					</Directory>
				</Directory>
				<Directory Id="IMCODERS.DIR" Name="ImageMagick-FAIL"><!-- fake Name -->
					<Component Id="IM_MOD_RL_fail_.dll" Guid="*">
						<File Id="IM_MOD_RL_fail_.dll" Name="IM_MOD_RL_fail_.dll" Source="IM_MOD_RL_fail_.dll" Checksum="yes" KeyPath="yes" />
					</Component>
				</Directory>
			</Directory>
			<Directory Id="ProgramMenuFolder" Name="Programs">
				<Directory Id="menu.dir" Name="FAIL">
					<Component Id="FAILWin.lnk" Guid="*">
						<RegistryValue Root="HKCU" Key="Software\FAIL" Name="ProgramsMenuFAILWin" Type="integer" Value="1" KeyPath="yes" />
						<Shortcut Id="FAILWin.lnk" Name="FAILWin" Target="[#failwin.exe]" />
					</Component>
					<Component Id="Documentation.lnk" Guid="*">
						<RemoveFolder Id="menu.dir" On="uninstall" />
						<RegistryValue Root="HKCU" Key="Software\FAIL" Name="ProgramsMenuDoc" Type="integer" Value="1" KeyPath="yes" />
						<Shortcut Id="Documentation.lnk" Name="Documentation" Target="[#README_WindowsSetup.html]" />
					</Component>
					<Component Id="Website.url" Guid="517E5616-5C8E-428B-834E-5059C00947F2">
						<RegistryValue Root="HKCU" Key="Software\FAIL" Name="ProgramsMenuWebsite" Type="integer" Value="1" KeyPath="yes" />
						<File Id="Website.url" Name="Website.url" Source="Website.url" />
					</Component>
					<Component Id="uninstall.lnk" Guid="*">
						<RegistryValue Root="HKCU" Key="Software\FAIL" Name="ProgramsMenuUninstall" Type="integer" Value="1" KeyPath="yes" />
						<Shortcut Id="uninstall.lnk" Name="Uninstall" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
					</Component>
				</Directory>
			</Directory>
			<Directory Id="DesktopFolder" Name="Desktop">
				<Component Id="FAILWin.desktop" Guid="*">
					<RegistryValue Root="HKCU" Key="Software\FAIL" Name="DesktopFAILWin" Type="integer" Value="1" KeyPath="yes" />
					<Shortcut Id="FAILWin.desktop" Name="FAILWin" Target="[#failwin.exe]" />
				</Component>
			</Directory>
		</Directory>

		<Feature Id="failwin" Title="FAILWin" Level="1" ConfigurableDirectory="FAIL.DIR" Description="Simple viewer." AllowAdvertise="no">
			<ComponentRef Id="failwin.exe" />
			<Feature Id="failwin.lnk" Title="Start menu shortcut" Level="1" Description="Adds FAILWin to the Programs menu." AllowAdvertise="no">
				<ComponentRef Id="FAILWin.lnk" />
			</Feature>
			<Feature Id="failwin.desktop" Title="Desktop shortcut" Level="9" Description="Adds FAILWin to the desktop." AllowAdvertise="no">
				<ComponentRef Id="FAILWin.desktop" />
			</Feature>
			<Feature Id="failwin.ext" Title="Associate file types" Level="9" Description="$(var.DOUBLECLICK) FAILWin." AllowAdvertise="no">
				<ComponentRef Id="failwin.ext" />
			</Feature>
		</Feature>
		<Feature Id="fail2png" Title="FAIL2PNG" Level="1" ConfigurableDirectory="FAIL.DIR" Description="Command-line converter to PNG files." AllowAdvertise="no">
			<ComponentRef Id="fail2png.exe" />
			<Feature Id="path" Title="Add to Path" Level="1" Description="Add the directory to the Path environment variable so that you don't have to type the location of fail2png at the command prompt." AllowAdvertise="no">
				<ComponentRef Id="path" />
			</Feature>
		</Feature>
		<Feature Id="xnview" Title="XnView plugin" Level="9" ConfigurableDirectory="XNVIEWPLUG.DIR" Description="Plugin for XnView." AllowAdvertise="no">
			<Condition Level="1">XNVIEWPLUG.DIR</Condition>
			<ComponentRef Id="Xfail1.usr" />
			<ComponentRef Id="Xfail2.usr" />
		</Feature>
		<Feature Id="imagemagick" Title="ImageMagick coder" Level="0" ConfigurableDirectory="IMCODERS.DIR" Description="Image coder for ImageMagick." AllowAdvertise="no">
			<Condition Level="1">IMCODERS.DIR</Condition>
			<ComponentRef Id="IM_MOD_RL_fail_.dll" />
		</Feature>
		<Feature Id="docs" Title="Documentation" Level="1" ConfigurableDirectory="FAIL.DIR" Description="Documentation file." AllowAdvertise="no">
			<ComponentRef Id="README_WindowsSetup.html" />
			<Feature Id="docs.lnk" Title="Start menu shortcuts" Level="1" Description="Adds documentation and website links to the Programs menu." AllowAdvertise="no">
				<ComponentRef Id="Documentation.lnk" />
				<ComponentRef Id="Website.url" />
			</Feature>
		</Feature>
		<Feature Id="uninstall" Title="Uninstall shortcut" Level="1" Description="Adds uninstall link to the Programs menu (in addition to the Control Panel which is always available)." AllowAdvertise="no">
			<ComponentRef Id="uninstall.lnk" />
		</Feature>

		<InstallExecuteSequence>
			<RemoveExistingProducts After="InstallFinalize" />
		</InstallExecuteSequence>

	</Product>
</Wix>
